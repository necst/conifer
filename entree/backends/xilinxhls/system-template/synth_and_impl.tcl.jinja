################################################################
# COMMAND-LINE ARGUMENTS
################################################################
set prj_root  [lindex $argv 0]
set prj_dir [lindex $argv 1]
set ip_dir [lindex $argv 2]
set xdc_dir [lindex $argv 3]
set prj_name {{projectname}}_system
set prj_part {{XilinxPart}}
set prj_board {{XilinxBoard}}
set sample_length {{num1}}
set n_classes {{class_count}}
set n_trees_per_class {{trees_per_class}}
set result_lenght {{num2}}
set output_length {{num3}}
set n_banks {{bank_count}}
set n_trees_per_bank {{trees_per_bank}}
set id_length {{num4}}
# TODO: add n_jobs variable in the writer
set n_jobs 12

open_project ${prj_dir}/${prj_root}.xpr
update_compile_order -fileset sources_1
open_bd_design ${prj_dir}/${prj_root}.srcs/sources_1/bd/top_system/top_system.bd


# generate output products for every element in the design
generate_target all [get_files  ${prj_dir}/${prj_root}.srcs/sources_1/bd/top_system/top_system.bd]
export_ip_user_files -of_objects [get_files ${prj_dir}/${prj_root}.srcs/sources_1/bd/top_system/top_system.bd] -no_script -sync -force -quiet
create_ip_run [get_files -of_objects [get_fileset sources_1] ${prj_dir}/${prj_root}.srcs/sources_1/bd/top_system/top_system.bd]
launch_runs top_system_* -jobs ${n_jobs}


# DFX wizard: set configurations and configuration runs
{%- set ns=namespace() %}
{%- set ns.config = 0 %}
{%- set ns.counter = 0 %}
{%- for i in iter_cfgs %}
    {%- if ns.counter==0 %}
        {%- set ns.newline='create_pr_configuration -name config_%d -partitions [list '|format( ns.config + 1 )%}
    {%- endif %}
            {%- set ns.newline='%stop_system_i/%s:%s_inst_0 '|format(ns.newline,set_properties[ns.counter]['rp'],set_properties[ns.counter]['rm'][ns.config])%}
    {%- if ns.counter==n_trees-1 %}
        {%- set ns.newline='%s]'|format(ns.newline)%}
{{ns.newline}}
        {%- set ns.config = ns.config + 1%}
        {%- set ns.counter=0%}
    {%- else %}
        {%- set ns.counter = ns.counter + 1 %}
    {%- endif %}
{%- endfor %}

{%- set ns.counter = 0 %}
{%- for i in iter_runs %}
    {%- if ns.counter==0 %}
        {%- set ns.newline='set_property PR_CONFIGURATION config_1 [get_runs impl_1]'%}
    {%- else %}
        {%- set ns.newline='create_run child_%d_impl_1 -parent_run impl_1 -flow {Vivado Implementation 2021} -pr_config config_%d'|format(ns.counter - 1, ns.counter + 1)%}
    {%- endif %}
    {%- set ns.counter = ns.counter + 1 %}
{{ns.newline}}
{%- endfor %}

# launch synthesis
launch_runs synth_1 -jobs ${n_jobs}
wait_on_run synth_1

# open synthesized design and add constraint
open_run synth_1 -name synth_1 -pr_config [current_pr_configuration]
add_files -fileset constrs_1 -norecurse ${xdc_dir}/${prj_part}.xdc
import_files -fileset constrs_1 ${xdc_dir}/${prj_part}.xdc
create_ip_run [get_files -of_objects [get_fileset sources_1] ${prj_dir}/${prj_root}.srcs/sources_1/bd/top_system/top_system.bd]
refresh_design

# launch implementation and bitstream write
reset_run synth_1
launch_runs impl_1 child_0_impl_1 child_1_impl_1 -to_step write_bitstream -jobs ${n_jobs}
wait_on_run impl_1 child_0_impl_1 child_1_impl_1

